---
title: "Project1"
output: pdf_document
---

#1

```{r echo = FALSE, warning = FALSE}
library(tidyverse)
library(knitr)

#standard theme
#theme_set(theme_gray())

### Use this to make it look like base R
theme_set(theme_bw())
theme_update(text = element_text(size=12),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
strip.background = element_blank()
)

data <- read.delim2("Projekt1_Grupp9.txt", sep = ";")

type1Data <- data %>% filter(ClaimType == 1)

type2Data <- data %>% filter(ClaimType == 2)

```


Assume 365 day/year and a month is 365/12 days (to get 12 months). 


```{r echo = FALSE, warning = FALSE}

data <- data %>% 
  mutate(Year = floor((.$ClaimDay-1)/(365)) + 1) %>% 
  mutate(ClaimDay = (ClaimDay-1) %% 365 + 1) %>% 
  mutate(Month = floor((.$ClaimDay-1)/(365/12)) + 1) 
data %>% tail()
#We can see seasonal effects
data %>% 
  ggplot(aes(Month)) +
  geom_bar() +
  scale_x_continuous(breaks=c(1:12)) +
  theme_classic() +
  facet_wrap(~ ClaimType, 
             labeller = labeller(ClaimType = c("1" = "Type 1", "2" = "Type 2")))
```

Reasonable to divide the months into two homogenous groups with their own process. One group for months $(1-4, 1-12)$ and one for months $(5-8)$.

```{r echo = FALSE, warning = FALSE}
#No effect over year for each claim type
data %>% 
  filter(ClaimType == 1) %>% 
  ggplot(aes(Month)) +
  geom_bar() +
  scale_x_continuous(breaks=c(1:12)) +
  theme_classic() +
  facet_wrap(~ Year, 
             labeller = labeller(ClaimType = c("1" = "Type 1", "2" = "Type 2")))

data %>% 
  filter(ClaimType == 2) %>% 
  ggplot(aes(Month)) +
  geom_bar() +
  scale_x_continuous(breaks=c(1:12)) +
  theme_classic() +
  facet_wrap(~ Year, 
             labeller = labeller(ClaimType = c("1" = "Type 1", "2" = "Type 2")))


#Add season, 2=summer, 1=else
data <- data %>% mutate(Season = ifelse(Month %in% 5:8, 2, 1))

aggregatedData <- data %>% group_by(ClaimType, ClaimDay, Month, Year, Season) %>% 
  summarise(NumberOfClaims=n(), AggregatedCost = sum(ClaimCost))

#Distribution of NumberOfClaims and fitted poisson as points
estimatedLambda <- (aggregatedData %>% 
  group_by(ClaimType, Season) %>% 
  summarize(lambda = mean(NumberOfClaims)))$lambda


aggregatedData %>% 
  filter(ClaimType == 1) %>% 
  filter(Season == 1) %>% 
  ggplot() +
  geom_bar(aes(x=NumberOfClaims, y = (..count..)/sum(..count..))) +
  geom_point(data = data.frame(x=c(0:35)), aes(x=x, y=dpois(x, estimatedLambda[1])))

aggregatedData %>% 
  filter(ClaimType == 1) %>% 
  filter(Season == 2) %>% 
  ggplot() +
  geom_bar(aes(x=NumberOfClaims, y = (..count..)/sum(..count..))) +
  geom_point(data = data.frame(x=c(0:17)), aes(x=x, y=dpois(x, estimatedLambda[2])))

aggregatedData %>% 
  filter(ClaimType == 2) %>% 
  filter(Season == 1) %>% 
  ggplot() +
  geom_bar(aes(x=NumberOfClaims, y = (..count..)/sum(..count..))) +
  geom_point(data = data.frame(x=c(0:20)), aes(x=x, y=dpois(x, estimatedLambda[3])))

aggregatedData %>% 
  filter(ClaimType == 2) %>% 
  filter(Season == 2) %>% 
  ggplot() +
  geom_bar(aes(x=NumberOfClaims, y = (..count..)/sum(..count..))) +
  geom_point(data = data.frame(x=c(0:10)), aes(x=x, y=dpois(x, estimatedLambda[4])))
```


#2

```{r echo = FALSE ,warning = FALSE, message = FALSE}

data %>% 
  group_by(ClaimType, Month)  %>% 
  summarize(MeanClaim = mean(ClaimCost)) %>% 
  filter(ClaimType == 1) %>% 
  ggplot(aes(x = Month, y = MeanClaim)) +
    geom_point()

data %>% 
  group_by(ClaimType, Month)  %>% 
  summarize(MeanClaim = mean(ClaimCost)) %>% 
  filter(ClaimType == 2) %>% 
  ggplot(aes(x = Month, y = MeanClaim)) +
    geom_point()

```

It seems as if the avergae claim costs are time independent, atleast when aggregated on a monthly basis, from the two previous plots.

```{r echo = FALSE ,warning = FALSE, message = FALSE}
#MeanClaim per day over time, ClaimType 1
data %>% 
  group_by(ClaimType, Year, ClaimDay)  %>% 
  summarize(MeanClaim = mean(ClaimCost)) %>% 
  filter(ClaimType == 1) %>% 
  ggplot(aes(x = ClaimDay, y = MeanClaim)) +
    geom_point()

#MeanClaim per day over time, ClaimType 2
data %>% 
  group_by(ClaimType, Year, ClaimDay)  %>% 
  summarize(MeanClaim = mean(ClaimCost)) %>% 
  filter(ClaimType == 2) %>% 
  ggplot(aes(x = ClaimDay, y = MeanClaim)) +
    geom_point()

#MeanClaim per season for each ClaimTpe
data %>% 
  group_by(ClaimType, Season)  %>% 
  summarize(MeanClaim = mean(ClaimCost)) %>% 
  ggplot(aes(x = Season, y = MeanClaim, fill=ClaimType %>% as.factor())) +
    scale_fill_discrete(name = "Claimtype") +
    geom_col()
```

The most extreme claims of claimtype 1 seem to occure during the summer. The average claimcost however does not differ between the seasons.

#3 

```{r echo = FALSE, warning = FALSE, message = FALSE}

t1Counts <- type1Data %>% 
  group_by(ClaimDay) %>% 
  summarize(Counts = n())

t2Counts <- type2Data %>% 
  group_by(ClaimDay) %>% 
  summarize(Counts = n()) 

aggClaims <- inner_join(t1Counts, t2Counts, by = "ClaimDay")

plot(aggClaims$Counts.x, aggClaims$Counts.y)

cor(aggClaims$Counts.x, aggClaims$Counts.y)

#There does seem to be daily correlation in the number of claims which we obviously have to deal with in one way or another

```

```{r echo = FALSE, message = FALSE}

type1Data %>% 
  group_by(ClaimDay) %>% 
  summarize(Counts = n(), MeanClaim = mean(ClaimCost)) %>% 
  group_by(Counts) %>% 
  summarize(MeanClaim = mean(MeanClaim)) %>% 
  ggplot(aes(x = Counts, y = MeanClaim)) +
    geom_point()

#Seems somewhat indep

type2Data %>% 
  group_by(ClaimDay) %>% 
  summarize(Counts = n(), MeanClaim = mean(ClaimCost)) %>% 
  group_by(Counts) %>% 
  summarize(MeanClaim = mean(MeanClaim)) %>% 
  ggplot(aes(x = Counts, y = MeanClaim)) +
    geom_point()

#Maybe not, idk

#Independent modelling anyways.

sampleD <- data %>% 
  group_by(Year, Month, Season) %>% 
  summarize(n1 = sum(ClaimType == 1), n2 = sum(ClaimType == 2)) 

s1 <- sampleD %>%
  data.frame() %>% 
  filter(Season == 1) %>% 
  sample_n(size = 8,replace = TRUE)

s2 <- sampleD %>%
  data.frame() %>% 
  filter(Season == 2) %>% 
  sample_n(size = 4,replace = TRUE)

claims <- rbind(s1[1:4,],s2, s1[5:8,]) %>% 
  select(n1, n2) 

costs <- data.frame(matrix(ncol = 2, nrow = 0)) 

#Ful loop IK men är trött och orkar ej googla

for(i in 1:nrow(bsSample)){
  
  TC1 = sum(sample(data[data$ClaimType == 1,]$ClaimCost, claims$n1[i], replace = TRUE))
  TC2 = sum(sample(data[data$ClaimType == 2,]$ClaimCost, claims$n2[i], replace = TRUE))
  
  costs <- rbind(costs, c(TC1, TC2)) %>% 
    setNames(c("c1", "c2"))
  
}

bsSample <- cbind(claims, costs) 

```





